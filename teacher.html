<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•¸å­¸ç·´åŠŸåŠ - V50.27 (æ•™å¸«ç«¯-é›²ç«¯ç‰ˆ)</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        :root {
            --primary: #4361ee; --primary-light: #eef2ff;
            --dark: #1a1a1a; --bg-grad-blue: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%);
            --success: #00b894; --error: #ff7675;
            --card-bg: rgba(255, 255, 255, 0.98);
            --radius: 24px;
        }
        body { font-family: "Noto Sans TC", sans-serif; background: var(--bg-grad-blue); color: var(--dark); display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; margin:0; overflow: hidden; }
        * { box-sizing: border-box; }
        .container { width: 100%; max-width: 1400px; height: 95vh; background: var(--card-bg); border-radius: var(--radius); box-shadow: 0 8px 32px rgba(0,0,0,0.15); display: flex; flex-direction: column; overflow: hidden; position: relative; }
        
        /* Header èª¿æ•´ */
        .header { height: 70px; padding: 0 20px; display: flex; justify-content: space-between; align-items: center; background: white; border-bottom: 1px solid #eee; flex-shrink: 0; gap: 20px; }
        
        .user-group { display: flex; gap: 10px; align-items: center; min-width: 150px; justify-content: flex-end; }
        .user-pill { background: var(--primary-light); color: var(--primary); padding: 5px 15px; border-radius: 50px; font-weight: bold; font-size: 0.85rem; white-space: nowrap; }
        .admin-pill { background: #6c5ce7; color: white; padding: 5px 15px; border-radius: 50px; font-weight: bold; font-size: 0.85rem; display: none; white-space: nowrap; }

        /* è·‘é¦¬ç‡ˆæ¨£å¼ */
        .marquee-container {
            flex: 1; background: #2c3e50; border-radius: 50px; height: 40px; overflow: hidden; position: relative; display: flex; align-items: center;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.3); border: 1px solid #34495e;
        }
        .marquee-content {
            position: absolute; white-space: nowrap; color: #f1c40f; font-weight: 700; font-size: 1rem; letter-spacing: 0.5px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5); will-change: transform; animation: marquee 60s linear infinite; transform: translate3d(0, 0, 0); 
        }
        @keyframes marquee { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }
        .marquee-container:hover .marquee-content { animation-play-state: paused; }

        .step-content { flex: 1; overflow-y: auto; padding: 20px 30px; display: flex; flex-direction: column; }
        .view-hidden { display: none !important; }

        .setup-grid { display: grid; grid-template-columns: 280px 1fr; gap: 30px; height: 100%; }
        .setup-sidebar { display: flex; flex-direction: column; gap: 15px; border-right: 1px solid #eee; padding-right: 25px; }
        .setup-main { display: flex; flex-direction: column; gap: 10px; overflow: hidden; }

        .mode-group { display: flex; background: #f1f2f6; padding: 4px; border-radius: 10px; gap: 4px; }
        .mode-btn { flex: 1; text-align: center; padding: 10px; cursor: pointer; border-radius: 8px; font-weight: bold; color: #666; transition: 0.2s; font-size: 0.9rem; }
        .mode-btn.active { background: white; color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        .checkbox-area { flex: 1; overflow-y: auto; display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 12px; padding: 5px; align-content: start; }
        
        .chk-card { display: flex; align-items: center; padding: 14px 18px; background: white; border: 2px solid #e0e0e0; border-radius: 12px; cursor: pointer; transition: 0.2s; color: #2d3436; }
        .chk-card:hover { border-color: var(--primary); background: #f8faff; }
        .chk-card.checked { background: var(--primary-light); border-color: var(--primary); color: var(--primary); box-shadow: 0 4px 12px rgba(67, 97, 238, 0.15); }
        .chk-card b { font-size: 1.05rem; font-weight: 700; letter-spacing: 0.5px; }
        .chk-card input { margin-right: 12px; transform: scale(1.2); accent-color: var(--primary); pointer-events: none; }

        .sidebar-scroll-box { height: 140px; overflow-y: auto; border: 2px solid #ddd; border-radius: 14px; padding: 8px; background: #fff; display: flex; flex-direction: column; gap: 5px; }
        .mini-chk { display: flex; align-items: center; padding: 8px; border-radius: 8px; cursor: pointer; font-size: 0.95rem; }
        .mini-chk:hover { background: #f1f2f6; }
        .mini-chk input { margin-right: 8px; transform: scale(1.1); accent-color: var(--primary); }

        select, input[type="number"], input[type="text"], input[type="password"] { width: 100%; padding: 16px; border: 2px solid #ddd; border-radius: 14px; font-size: 1.1rem; outline: none; transition: 0.2s; }
        input:focus { border-color: var(--primary); box-shadow: 0 0 0 4px var(--primary-light); }

        .btn { padding: 15px; border: none; border-radius: 12px; font-size: 1.1rem; font-weight: 700; cursor: pointer; transition: 0.3s; color: white; display: flex; justify-content: center; align-items: center; gap: 8px; }
        .btn-main { background: linear-gradient(135deg, var(--primary), #3a86ff); width: 100%; }
        .btn-sec { background: #f1f2f6; color: #555; width: 100%; }
        .btn-admin { background: linear-gradient(135deg, #6c5ce7, #a29bfe); margin-bottom: 10px; width: 100%; }
        
        .quiz-container { display: flex; flex-direction: column; height: 100%; gap: 10px; }
        .quiz-top { flex: 1; background: white; border-radius: 20px; border: 1px solid #eee; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; overflow: hidden; }
        
        .q-meta-info { position: absolute; top: 15px; left: 20px; display: flex; flex-direction: column; gap: 5px; z-index:10; }
        .small-badge { padding: 3px 10px; border-radius: 6px; font-size: 0.75rem; font-weight: 700; color: white; background: rgba(0,0,0,0.4); backdrop-filter: blur(2px); width: fit-content; }
        
        .timer-pill { position: absolute; top: 15px; right: 20px; background: #d63031; color: white; font-weight: 900; padding: 6px 18px; border-radius: 50px; z-index: 10; }

        #qImg { max-width: 90%; max-height: 55vh; object-fit: contain; }
        .opt-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; flex-shrink: 0; padding-bottom: 5px; }
        .btn-opt { height: 75px; border: 3px solid #eee; background: white; border-radius: 16px; font-size: 2rem; font-weight: 900; color: #444; cursor: pointer; }
        .btn-opt.correct { background: var(--success); color: white; border-color: var(--success); }
        .btn-opt.wrong { background: var(--error); color: white; border-color: var(--error); }

        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9); z-index: 9999; align-items: center; justify-content: center; }
        .modal-content { width: 90%; max-width: 950px; aspect-ratio: 16/9; background: black; border-radius: 12px; position: relative; }
        #vidFrame { width: 100%; height: 100%; border: none; border-radius: 12px; }
        .btn-close-modal { position: absolute; top: -45px; right: 0; background: none; border: none; color: white; font-size: 35px; cursor: pointer; }
        
        .brand-container { display:flex; align-items:center; gap:12px; min-width: 280px; }
        .brand-logo-img { height:38px; width:auto; display:block; }
        .brand-backup-icon { font-size:28px; color:var(--primary); display:none; }
        .brand-text { margin:0; display:flex; align-items:center; gap:10px; }
        .brand-name { color:#2d3436; font-size:1.1rem; font-weight:700; letter-spacing: 1px; }
        .brand-divider { color:#ddd; font-weight:300; }
        .brand-sub { color:var(--primary); display:flex; align-items:center; gap:8px; font-size:1.1rem; white-space: nowrap; }
        .brand-sub-note { font-size:0.8rem; color:#666; font-weight:500; }
        .warning-blink {
            position: absolute; bottom: 15px; font-size: 0.9rem; font-weight: 700; color: #d63031;
            background: rgba(255, 255, 255, 0.8); padding: 5px 15px; border-radius: 50px;
            animation: slowBlink 3s infinite ease-in-out; z-index: 5;
        }
        @keyframes slowBlink { 0%, 100% { opacity: 1; } 50% { opacity: 0.2; } }

        @media (max-width: 900px) {
            .brand-sub-note { display:none; }
            .marquee-container { display: none; } 
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div class="brand-container">
            <img src="https://img1.pixhost.to/images/11156/674359767_logo.png" 
                 class="brand-logo-img" 
                 alt="Logo"
                 onerror="this.style.display='none'; document.getElementById('backupIcon').style.display='block';">
            <i id="backupIcon" class="fas fa-book-open brand-backup-icon"></i>

            <h2 class="brand-text">
                <span class="brand-name">å ¯ç¿°æ–‡æ•™</span>
                <span class="brand-divider">|</span>
                <span class="brand-sub">
                    <i class="fas fa-calculator"></i> æ•¸å­¸ç·´åŠŸåŠ 
                    <span class="brand-sub-note">(å¯è‡ªå‹•æ™‰ç´šæ‰“æ€ªæµç¨‹)</span>
                </span>
            </h2>
        </div>

        <div class="marquee-container">
            <div id="marqueeText" class="marquee-content">
                ğŸš€ æ•´åˆå¯¦é«”æ•™å­¸èˆ‡æ•¸ä½ç·´åŠŸï¼Œæ‰“é€ æœ€æ‰å¯¦çš„æ•¸ç†åŸºç¤ï¼ ğŸš€ æ­¡è¿ä¾†åˆ°æ•¸å­¸ç·´åŠŸåŠï¼ (æ’è¡Œæ¦œè¼‰å…¥ä¸­...)
            </div>
        </div>
        
        <div class="user-group">
            <div id="adminBadge" class="admin-pill">ğŸ‘‘ ç®¡ç†å“¡</div>
            <div id="userInfo" class="user-pill" style="display:none;"></div>
            <button onclick="doLogout()" id="btnLogout" class="btn" style="background:none; border:1px solid #ddd; color:#888; width:auto; padding:5px 15px; font-size:0.8rem; display:none;">ç™»å‡º</button>
        </div>
    </div>

    <div id="step-0" class="step-content">
        <div style="max-width:420px; margin:auto; text-align:center; padding-top: 30px;">
            <i class="fas fa-user-astronaut" style="font-size:4.5rem; color:var(--primary); margin-bottom:15px;"></i>
            
            <h4 style="background: linear-gradient(to right, #4361ee, #e84393); -webkit-background-clip: text; color: transparent; font-size: 1.1rem; margin: 0 0 20px 0; font-weight: 800; letter-spacing: 1px;">
                æ•´åˆå¯¦é«”æ•™å­¸èˆ‡æ•¸ä½ç·´åŠŸ<br>æ‰“é€ æœ€æ‰å¯¦çš„æ•¸ç†åŸºç¤
            </h4>

            <h3 style="font-size:1.6rem; margin-bottom:25px; font-weight:900;">ç®¡ç†å“¡ / æ¸¬è©¦ç™»å…¥</h3>
            <div id="taskNotice" style="background:#fff3cd; color:#856404; padding:12px; border-radius:12px; margin-bottom:15px; display:none; font-weight:bold;">æ‚¨æ­£åœ¨ä½¿ç”¨ä»»å‹™é€£çµé€²å…¥æ¸¬è©¦</div>
            <input type="text" id="userId" placeholder="è«‹è¼¸å…¥å­¸è™Ÿ / å¸³è™Ÿ" style="margin-bottom:15px;">
            <input type="password" id="userPass" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" style="margin-bottom:25px;">
            <button id="btnLogin" onclick="doLogin()" class="btn btn-main" style="height:60px; font-size:1.3rem;">ç™»å…¥ç³»çµ±</button>
        </div>
    </div>

    <div id="step-1" class="step-content view-hidden">
        <div class="setup-grid">
            <div class="setup-sidebar">
                <button id="btnAdminLink" onclick="generateTaskLink()" class="btn btn-admin"><i class="fas fa-link"></i> è¤‡è£½ä»»å‹™é€£çµ (çµ¦å­¸ç”Ÿ)</button>
                <label style="font-weight:bold;">å‡ºé¡Œæ¨¡å¼</label>
                <div class="mode-group">
                    <div class="mode-btn active" id="m-kp" onclick="setMode('kp')">çŸ¥è­˜é»</div>
                    <div class="mode-btn" id="m-chap" onclick="setMode('chapter')">ç« ç¯€</div>
                    <div class="mode-btn" id="m-rev" onclick="setMode('review')">ç¸½è¤‡ç¿’</div>
                </div>
                
                <div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px;">
                    <label style="font-weight:bold;">è€ƒé¡Œä¾†æº</label>
                    <button onclick="toggleAllSources()" style="color:var(--primary); border:none; background:none; font-size:0.8rem; cursor:pointer;">å…¨é¸/å–æ¶ˆ</button>
                </div>
                <div id="srcFilterArea" class="sidebar-scroll-box">è¼‰å…¥ä¸­...</div>

                <label style="font-weight:bold; margin-top:10px;">é›£æ˜“åº¦</label>
                <select id="levelSelect"><option value="C">â­ï¸ Level C</option><option value="B">â­â­ Level B</option><option value="A">â­â­â­ Level A</option></select>
                <label style="font-weight:bold; margin-top:10px;">å‡ºé¡Œç¸½æ•¸</label>
                <input type="number" id="qCount" value="10" min="1">
                <div style="margin-top:auto;"><button id="btnStart" onclick="startPractice()" class="btn btn-main">ğŸš€ é–‹å§‹æ¸¬è©¦ (æ¨¡æ“¬å­¸ç”Ÿ)</button></div>
            </div>
            <div class="setup-main">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <label style="font-weight:bold;">é¸æ“‡ç¯„åœ</label>
                    <button onclick="toggleAll()" style="color:var(--primary); border:none; background:none; font-weight:bold; cursor:pointer;">å…¨é¸ / å–æ¶ˆ</button>
                </div>
                <div id="filterArea" class="checkbox-area">è¼‰å…¥é¡Œåº«ä¸­...</div>
            </div>
        </div>
    </div>

    <div id="step-2" class="step-content view-hidden">
        <div id="loadingUI" style="text-align:center; padding-top:100px;"><i class="fas fa-spinner fa-spin fa-3x" style="color:var(--primary);"></i><p>æ­£åœ¨çµ„å·ä¸­...</p></div>
        <div id="quizUI" class="quiz-container" style="display:none;">
            <div class="quiz-top">
                <div class="q-meta-info">
                    <span class="small-badge" style="background:var(--primary);">é¡Œè™Ÿï¼š<span id="qIdxTxt">1</span></span>
                    <span class="small-badge">çŸ¥è­˜é»ï¼š<span id="qCatTxt">è¼‰å…¥ä¸­</span></span>
                    <span class="small-badge">ä¾†æºï¼š<span id="qSrcTxt">è¼‰å…¥ä¸­</span></span>
                </div>
                <div class="timer-pill"><i class="fas fa-clock"></i> <span id="timerTxt">--:--</span></div>
                
                <img id="qImg" src="">

                <div class="warning-blink">
                    <i class="fas fa-exclamation-triangle"></i> ç®¡ç†å“¡æ¸¬è©¦ä¸­ (ç´€éŒ„å°‡æ¨™è¨˜ç‚ºæ¸¬è©¦å¸³è™Ÿ)
                </div>

                <div id="feedback" style="position:absolute; bottom:20px; font-weight:900; font-size:2rem; display:none;"></div>
            </div>
            <div id="actionArea" class="view-hidden" style="display:flex; justify-content:center; gap:20px;">
                <button id="btnVid" onclick="showVideo()" class="btn" style="background:#f39c12; width:180px;"><i class="fas fa-video"></i> è§€çœ‹è§£æ</button>
                <button onclick="goNext()" class="btn btn-main" style="width:280px;">ä¸‹ä¸€é¡Œ <i class="fas fa-arrow-right"></i></button>
            </div>
            <div class="opt-grid">
                <button class="btn-opt" onclick="handleAns('A', this)">A</button>
                <button class="btn-opt" onclick="handleAns('B', this)">B</button>
                <button class="btn-opt" onclick="handleAns('C', this)">C</button>
                <button class="btn-opt" onclick="handleAns('D', this)">D</button>
            </div>
        </div>
    </div>

    <div id="step-3" class="step-content view-hidden" style="text-align:center;">
        <h1 style="font-size:5rem; font-weight:900; color:var(--primary); margin-top:30px;" id="finalScoreTxt">0</h1>
        <h2>ä¿®ç…‰å®Œæˆ</h2>
        <div style="display:flex; flex-direction:column; align-items:center; gap:20px; margin-top:40px;">
            <button id="btnLevelUp" onclick="doPromotion()" class="btn view-hidden" style="background:linear-gradient(135deg, #f39c12, #e67e22); padding:15px 40px;"></button>
            <div style="display:flex; gap:15px;">
                <button onclick="backToMenu()" class="btn btn-sec" style="width:150px;">å›ä¸»é¸å–®</button>
                <button onclick="replayGame()" class="btn btn-main" style="width:150px;">å†ç·´ä¸€æ¬¡</button>
            </div>
        </div>
    </div>
</div>

<div id="videoModal" class="modal">
    <div class="modal-content">
        <button class="btn-close-modal" onclick="closeVideo()">âœ•</button>
        <iframe id="vidFrame" sandbox="allow-scripts allow-same-origin allow-presentation" allowfullscreen></iframe>
    </div>
</div>

<script>
    // ==========================================
    // â˜…â˜…â˜… é›²ç«¯åŒ–è¨­å®šå€ (å·²æ›¿æ›ç‚ºæ‚¨æä¾›çš„æ­£å¼ç¶²å€) â˜…â˜…â˜…
    // ==========================================
    const CONFIG = { 
        API_URL: "https://script.google.com/macros/s/AKfycbwg9OdGF4z9VX_wA20K4s7Umj7FWEaMSNmFs1XFaL1BX7RSDKk1bLbJicEEahBdL305pg/exec", 
        STUDENT_CSV: "https://docs.google.com/spreadsheets/d/e/2PACX-1vTOp8_OhMQquledyo1XszmXCvpAQdLlmbCtSvoinrOuqOQy1euxLJzvDUpzzPjRFJOrTawtelhlVM7N/pub?gid=777921930&single=true&output=csv" 
    };
    // ==========================================

    let students = {}, meta = {}, questions = [], qIdx = 0, score = 0, user = {}, timer = null, sessionToken = "", currentMode = "kp", currentLevel = "C";
    let lastFetchParams = null; 

    // --- æ¨™æº–åŒ–å‡½å¼ (å…¨å½¢è½‰åŠå½¢ã€å¤§å¯«ã€å»ç©ºç™½) ---
    function toNormal(str) {
        if (!str) return "";
        return str.toString()
            .replace(/[\uff01-\uff5e]/g, c => String.fromCharCode(c.charCodeAt(0) - 0xfee0)) // å…¨å½¢è½‰åŠå½¢
            .toUpperCase() // è½‰å¤§å¯«
            .trim(); // å»ç©ºç™½
    }
    // ------------------------------------------------

    window.onload = () => {
        Papa.parse(CONFIG.STUDENT_CSV + "&t=" + Date.now(), { download: true, header: true, complete: r => { r.data.forEach(s => { let ac = s['å¸³è™Ÿ'] || s['User']; if(ac) students[ac.trim()] = s; }); } });
        
        fetch(CONFIG.API_URL + "?action=getMetadata").then(r => r.json()).then(d => { 
            meta = d; 
            updateFilter();
            const srcArea = document.getElementById('srcFilterArea');
            if(d.sources) {
                srcArea.innerHTML = d.sources.map(src => 
                    `<div class="mini-chk" onclick="const ck=this.querySelector('input'); ck.checked=!ck.checked;"><input type="checkbox" value="${src}" checked onclick="event.stopPropagation()"><span>${src}</span></div>`
                ).join('');
            } else { srcArea.innerHTML = "ç„¡è³‡æ–™"; }
        });

        fetchLeaderboard();

        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('task') || urlParams.has('taskMode')) {
            document.getElementById('taskNotice').style.display = 'block';
        }
    };

    function fetchLeaderboard() {
        const marquee = document.getElementById('marqueeText');
        fetch(CONFIG.API_URL + "?action=getLeaderboard")
        .then(r => r.json())
        .then(data => {
            if (data.rank && data.rank.length > 0) {
                let txt = "ğŸ† æ‰“æ€ªåäººå ‚ (æ­£ç¢ºç‡ Top 5)ï¼š ";
                data.rank.forEach((r, i) => {
                    let displayUser = r.user; 
                    txt += `ã€ç¬¬${i+1}åã€‘${displayUser} (${r.rate}%)   `;
                });
                txt += "   ğŸ”¥ åŠªåŠ›ä¿®ç…‰ï¼Œä½ ä¹Ÿèƒ½ä¸Šæ¦œï¼";
                marquee.innerText = txt;
            } else {
                marquee.innerText = "ğŸš€ æ•´åˆå¯¦é«”æ•™å­¸èˆ‡æ•¸ä½ç·´åŠŸï¼Œæ‰“é€ æœ€æ‰å¯¦çš„æ•¸ç†åŸºç¤ï¼ ğŸš€ æ­¡è¿ä¾†åˆ°æ•¸å­¸ç·´åŠŸåŠï¼ (ç›®å‰å°šç„¡æ’åè³‡æ–™)";
            }
        })
        .catch(e => { marquee.innerText = "ğŸš€ æ­¡è¿ä¾†åˆ°æ•¸å­¸ç·´åŠŸåŠï¼ä»Šæ—¥ç›®æ¨™ï¼šæŒ‘æˆ°æ¥µé™ï¼Œçªç ´è‡ªæˆ‘ï¼"; });
    }

    function setMode(m) {
        currentMode = m;
        ['kp','chap','rev'].forEach(id => document.getElementById('m-'+id).classList.toggle('active', id === 'm-'+(m==='chapter'?'chap':(m==='review'?'rev':'kp'))));
        updateFilter();
    }

    function updateFilter() {
        let list = (currentMode === 'kp' ? meta.kps : (currentMode === 'chapter' ? meta.chapters : meta.reviews)) || [];
        document.getElementById('filterArea').innerHTML = list.map(tag => `
            <div class="chk-card" onclick="toggleCard(this)">
                <input type="checkbox" value="${tag}">
                <b>${tag}</b>
            </div>
        `).join('');
    }

    function toggleCard(card) {
        const ck = card.querySelector('input');
        ck.checked = !ck.checked;
        if(ck.checked) card.classList.add('checked');
        else card.classList.remove('checked');
    }

    async function doLogin() {
        const uId = document.getElementById('userId').value.trim(), uPass = document.getElementById('userPass').value.trim();
        const btn = document.getElementById('btnLogin');
        btn.disabled = true; btn.innerHTML = 'é©—è­‰ä¸­...';

        if ((uId === 'admin' && uPass === 'admin') || (uId === 'persist' && uPass === 'persist')) {
            user = { id: uId, name: (uId==='admin'?'è¶…ç´šç®¡ç†å“¡':'æ¸¬è©¦å¸³è™Ÿ'), isAdmin: true };
            document.getElementById('btnAdminLink').style.display = 'flex';
            document.getElementById('adminBadge').style.display = 'block';
            afterLogin(); return;
        }

        if(students[uId] && students[uId]['å¯†ç¢¼'] === uPass) {
            try {
                const res = await fetch(`${CONFIG.API_URL}?action=registerLogin&user=${uId}`).then(r => r.json());
                sessionToken = res.token; user = { id: uId, name: students[uId]['é¡¯ç¤ºåç¨±'] || students[uId]['å§“å'] };
                afterLogin(); 
            } catch(e) { alert("é€£ç·šè¶…æ™‚ï¼è«‹æª¢æŸ¥ API æˆ–ç¶²è·¯ã€‚"); resetLoginBtn(); }
        } else { alert("å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤"); resetLoginBtn(); }
    }

    function resetLoginBtn() { document.getElementById('btnLogin').disabled = false; document.getElementById('btnLogin').innerHTML = 'ç™»å…¥ç³»çµ±'; }
    
    function afterLogin() {
        document.getElementById('userInfo').innerText = ` ${user.name}`;
        document.getElementById('userInfo').style.display = 'block';
        document.getElementById('btnLogout').style.display = 'block';
        
        const urlParams = new URLSearchParams(window.location.search);
        if ((urlParams.has('task') || urlParams.has('taskMode'))) {
            executeTask();
        } else {
            showStep(1);
        }
    }

    function doLogout() { location.href = window.location.pathname; } 

    function generateTaskLink() {
        const tags = Array.from(document.querySelectorAll('#filterArea input:checked')).map(i => i.value);
        if(!tags.length) return alert("è«‹å…ˆå‹¾é¸ç¯„åœ");
        const l = document.getElementById('levelSelect').value, c = document.getElementById('qCount').value;
        const selectedSrc = Array.from(document.querySelectorAll('#srcFilterArea input:checked')).map(i => i.value);
        const srcStr = selectedSrc.length > 0 ? selectedSrc.join(',') : 'ALL';

        const taskId = 'T' + Date.now() + Math.floor(Math.random() * 1000);
        const taskUrl = `${window.location.href.split('?')[0]}?task=1&tid=${taskId}&mode=${currentMode}&level=${l}&count=${c}&source=${encodeURIComponent(srcStr)}&tags=${encodeURIComponent(tags.join(','))}`;
        
        fetch(CONFIG.API_URL, { method: 'POST', body: JSON.stringify({ action: 'saveAssignment', mode: currentMode, level: l, count: c, tags: tags.join(','), link: taskUrl, taskId: taskId }) });
        
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(taskUrl).then(() => alert("âœ… ä»»å‹™é€£çµå·²è¤‡è£½ï¼\n\n" + taskUrl)).catch(err => prompt("è«‹æ‰‹å‹•è¤‡è£½ï¼š", taskUrl));
        } else {
            prompt("ä»»å‹™é€£çµå·²ç”¢ç”Ÿï¼š", taskUrl);
        }
    }

    async function startPractice() {
        const tags = Array.from(document.querySelectorAll('#filterArea input:checked')).map(i => i.value);
        if(!tags.length) return alert("è«‹é¸æ“‡ç¯„åœ");
        
        const selectedSrc = Array.from(document.querySelectorAll('#srcFilterArea input:checked')).map(i => i.value);
        
        fetchQuestions({ 
            mode: currentMode, 
            level: document.getElementById('levelSelect').value, 
            count: document.getElementById('qCount').value, 
            source: selectedSrc.length > 0 ? selectedSrc.join(',') : 'ALL', 
            tags: tags 
        });
    }

    function executeTask() {
        const p = new URLSearchParams(window.location.search);
        currentMode = p.get('mode') || 'kp';
        
        fetchQuestions({ 
            mode: currentMode, 
            level: p.get('level'), 
            count: p.get('count'), 
            source: p.get('source') || p.get('sources') || 'ALL', 
            tags: p.get('tags').split(',') 
        });
    }

    function replayGame() {
        if (lastFetchParams) fetchQuestions(lastFetchParams);
        else showStep(1);
    }
    
    function backToMenu() {
        window.history.pushState({}, document.title, window.location.pathname);
        showStep(1);
    }

    async function fetchQuestions(params) {
        clearInterval(timer);
        qIdx = 0;
        score = 0;
        questions = []; 
        lastFetchParams = params;
        currentLevel = params.level; 

        showStep(2);

        document.getElementById('quizUI').style.display = 'none';
        document.getElementById('loadingUI').style.display = 'block';
        
        try {
            const res = await fetch(`${CONFIG.API_URL}?action=getQuestions&mode=${params.mode}&level=${params.level}&count=${params.count}&source=${encodeURIComponent(params.source)}&tags=${encodeURIComponent(params.tags)}`).then(r => r.json());
            if(res.questions && res.questions.length > 0) {
                questions = res.questions; 
                qIdx = 0; score = 0;
                
                document.getElementById('loadingUI').style.display = 'none';
                document.getElementById('quizUI').style.display = 'flex';
                renderQ();
            } else { alert("æŸ¥ç„¡é¡Œç›®ï¼(å¯èƒ½æ˜¯è©²ç­‰ç´šç„¡é¡Œç›®)"); showStep(1); }
        } catch(e) { alert("çµ„å·è¶…æ™‚ï¼"); showStep(1); }
    }

    function renderQ() {
        if(timer) clearInterval(timer);
        
        const q = questions[qIdx];
        document.getElementById('qIdxTxt').innerText = `${qIdx+1} / ${questions.length}`;
        document.getElementById('qCatTxt').innerText = q.cat || "ç„¡";
        document.getElementById('qSrcTxt').innerText = q.src || "ç„¡";
        
        const img = document.getElementById('qImg');
        if(q.img && q.img.length > 5 && q.img !== 'ç„¡') {
            img.src = q.img; img.style.display = 'block';
        } else {
            img.style.display = 'none'; 
        }

        document.querySelectorAll('.btn-opt').forEach(b => { b.className = 'btn-opt'; b.disabled = false; });
        document.getElementById('feedback').style.display = 'none';
        document.getElementById('actionArea').classList.add('view-hidden');
        startTimer();
    }

    function startTimer() {
        if(timer) clearInterval(timer);
        
        let duration = (currentLevel==='C'?180:(currentLevel==='B'?240:300));
        let endTime = Date.now() + duration * 1000;
        
        const update = () => {
            let now = Date.now();
            let remaining = Math.ceil((endTime - now) / 1000);
            
            if (remaining < 0) remaining = 0;
            
            let m = Math.floor(remaining / 60);
            let s = remaining % 60;
            document.getElementById('timerTxt').innerText = `${m}:${s<10?'0':''}${s}`;
            
            if (remaining <= 0) {
                clearInterval(timer);
                timer = null;
                handleAns('TIMEOUT', null);
            }
        };
        
        update(); 
        timer = setInterval(update, 500); 
    }

    function handleAns(ans, btn) {
        if (document.querySelectorAll('.btn-opt:disabled').length > 0 && ans !== 'TIMEOUT') return;
        
        clearInterval(timer);
        timer = null;
        
        if (!questions[qIdx]) return; 

        const q = questions[qIdx];
        // --- ä¿®æ”¹è™•ï¼šä½¿ç”¨ toNormal å¯¬å®¹åˆ¤æ–· ---
        const isRight = (toNormal(ans) === toNormal(q.ans));
        // ------------------------------------
        
        if(isRight) score++;
        
        document.querySelectorAll('.btn-opt').forEach(b => { 
            b.disabled = true; 
            // --- ä¿®æ”¹è™•ï¼šæŒ‰éˆ•é¡è‰²åˆ¤æ–·ä¹ŸåŠ ä¸Š toNormal ---
            if(toNormal(b.innerText) === toNormal(q.ans)) b.classList.add('correct'); 
            else if(b === btn) b.classList.add('wrong'); 
        });

        const fb = document.getElementById('feedback');
        fb.style.display = 'block'; fb.style.color = isRight ? 'var(--success)' : 'var(--error)';
        fb.innerHTML = isRight ? "ğŸ‰ ç­”å°äº†ï¼" : "âŒ ç­”éŒ¯äº†ï¼Œç­”æ¡ˆæ˜¯ " + q.ans;
        
        document.getElementById('actionArea').classList.remove('view-hidden');
        document.getElementById('btnVid').classList.toggle('view-hidden', !q.vid || q.vid === "ç„¡");
        
        fetch(CONFIG.API_URL, { 
            method: 'POST', mode: 'no-cors', 
            body: JSON.stringify({ action: 'saveRecord', user: user.id, username: user.name, topic: q.cat, level: currentLevel, result: isRight ? 'CORRECT' : 'WRONG', qId: q.qId, userAns: ans, correctAns: q.ans }) 
        });
    }

    function showVideo() {
        let v = questions[qIdx].vid;
        if(v.includes('youtu')) { v = v.replace('watch?v=','embed/').replace('youtu.be/','www.youtube.com/embed/'); }
        document.getElementById('vidFrame').src = v + (v.includes('?') ? '&' : '?') + "autoplay=1&rel=0&modestbranding=1";
        document.getElementById('videoModal').style.display = 'flex';
    }
    function closeVideo() { document.getElementById('videoModal').style.display = 'none'; document.getElementById('vidFrame').src = ""; }
    
    function goNext() { 
        qIdx++; 
        if(qIdx < questions.length) renderQ(); 
        else showFinal(); 
    }

    function showFinal() {
        clearInterval(timer); 
        showStep(3);
        const s = Math.round(score/questions.length*100);
        document.getElementById('finalScoreTxt').innerText = s;
        
        const btnLv = document.getElementById('btnLevelUp');
        btnLv.classList.add('view-hidden');

        if(s >= 80) {
            confetti({ particleCount: 150, spread: 70 });
            if(currentLevel === "C") { btnLv.innerText = "æŒ‘æˆ° Level B"; btnLv.classList.remove('view-hidden'); }
            else if(currentLevel === "B") { btnLv.innerText = "æŒ‘æˆ° Level A"; btnLv.classList.remove('view-hidden'); }
        }
    }

    function doPromotion() { 
        const newLevel = currentLevel === "C" ? "B" : "A";
        document.getElementById('levelSelect').value = newLevel;

        if (lastFetchParams) {
             const newParams = { ...lastFetchParams };
             newParams.level = newLevel;
             fetchQuestions(newParams);
        } else {
             startPractice(); 
        }
    }

    function showStep(s) { document.querySelectorAll('.step-content').forEach((el, i) => el.classList.toggle('view-hidden', i !== s)); }
    
    function toggleAll() { 
        const cks = document.querySelectorAll('#filterArea input'); 
        const allChecked = Array.from(cks).every(i => i.checked); 
        cks.forEach(i => {
            i.checked = !allChecked;
            if(i.checked) i.parentElement.classList.add('checked');
            else i.parentElement.classList.remove('checked');
        }); 
    }
    function toggleAllSources() { const cks = document.querySelectorAll('#srcFilterArea input'); const allChecked = Array.from(cks).every(i => i.checked); cks.forEach(i => i.checked = !allChecked); }
</script>
</body>
</html>
